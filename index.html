<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caonem Card Game (Firebase)</title>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: white; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #e67e22; border: none; color: white; border-radius: 5px; margin: 5px; transition: 0.2s;}
        button:hover { background: #d35400; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        input { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; color: #333; }
        .card { width: 60px; height: 90px; background: white; color: black; display: inline-flex; align-items: center; justify-content: center; margin: 5px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 3px solid transparent; position: relative; user-select: none; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        .card.selected { border-color: #e74c3c; transform: translateY(-10px); }
        .card.pool-card { background: #3498db; color: white; }
        .card.pool-selected { border-color: #f1c40f; box-shadow: 0 0 15px #f1c40f; }
        .game-area { margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; }
        .status-log { margin-bottom: 10px; font-style: italic; color: #f1c40f; min-height: 24px; }
        .player-box { border: 1px solid #7f8c8d; padding: 10px; margin: 10px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .turn-indicator { color: #2ecc71; font-weight: bold; font-size: 1.2em; animation: blink 1s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.6; } }
        .me-badge { background: #27ae60; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1>üÉè C√†o N√™m (Firebase Ver)</h1>

        <div v-if="step === 'login'">
            <input v-model="myName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="15" />
            <br><br>
            <button @click="createRoom" :disabled="!myName || loading">T·∫°o Ph√≤ng M·ªõi</button>
            <div style="margin: 10px; opacity: 0.7;">HO·∫∂C</div>
            <input v-model="joinId" placeholder="Nh·∫≠p M√£ Ph√≤ng" style="text-transform: uppercase;" />
            <button @click="joinRoom" :disabled="!myName || !joinId || loading">V√†o Ph√≤ng</button>
            <p v-if="loading" style="color: #f39c12;">ƒêang k·∫øt n·ªëi...</p>
        </div>

        <div v-else-if="step === 'lobby'">
            <h2>Ph√≤ng: <span style="color:#f1c40f; font-family: monospace; font-size: 1.5em;">{{ roomId }}</span></h2>
            <p>Copy m√£ ph√≤ng g·ª≠i cho b·∫°n b√®</p>
            
            <div class="game-area">
                <h3>Danh s√°ch ng∆∞·ªùi ch∆°i ({{ players.length }})</h3>
                <div v-for="p in players" :key="p.id" class="player-box">
                    <span>
                        <span v-if="p.id === hostId">üëë</span> 
                        {{ p.name }} 
                        <span v-if="p.id === myId" class="me-badge">B·∫°n</span>
                    </span>
                    <span v-if="p.ready" style="color:#2ecc71">S·∫µn s√†ng</span>
                    <span v-else>ƒêang ch·ªù...</span>
                </div>
            </div>

            <div v-if="isHost">
                <button @click="startGame" :disabled="players.length < 2">B·∫Øt ƒë·∫ßu Game</button>
                <p v-if="players.length < 2" style="font-size: 0.9em; color: #95a5a6;">C·∫ßn √≠t nh·∫•t 2 ng∆∞·ªùi ƒë·ªÉ ch∆°i</p>
            </div>
            <div v-else>
                <p>Ch·ªù ch·ªß ph√≤ng ({{ hostName }}) b·∫Øt ƒë·∫ßu...</p>
            </div>
        </div>

        <div v-else-if="step === 'game'">
            <div class="status-log">{{ statusMessage }}</div>

            <div class="game-area" v-if="gamePhase === 'picking'">
                <h3>B√†i Chung (Pool)</h3>
                <div>
                    <div 
                        v-for="(card, index) in pool" 
                        class="card pool-card"
                        :class="{ 'pool-selected': selectedPoolIndex === index }"
                        @click="selectPoolCard(index)">
                        {{ card }}
                    </div>
                </div>
            </div>

            <div class="game-area">
                <h3>B√†i c·ªßa b·∫°n</h3>
                <div style="min-height: 100px;">
                    <div 
                        v-for="(card, index) in myHand" 
                        class="card" 
                        :class="{ 'selected': selectedHandIndex === index }"
                        @click="selectHandCard(index)">
                        {{ card }}
                    </div>
                </div>

                <div v-if="gamePhase === 'offering'">
                    <p>Ch·ªçn 1 l√° b√†i ƒë·ªÉ g√≥p v√†o n√™m (Pool)</p>
                    <button @click="submitOffer" :disabled="selectedHandIndex === null || hasOffered">
                        {{ hasOffered ? "ƒê√£ G√≥p Xong (Ch·ªù ng∆∞·ªùi kh√°c)" : "G√≥p B√†i N√†y" }}
                    </button>
                </div>

                <div v-if="gamePhase === 'picking'">
                    <div v-if="isMyTurn">
                        <p class="turn-indicator">‚ö° T·ªöI L∆Ø·ª¢T B·∫†N!</p>
                        <p>Ch·ªçn 1 l√° trong Pool v√† 1 l√° tr√™n Tay ƒë·ªÉ ƒë·ªïi</p>
                        <button @click="submitSwap" :disabled="selectedHandIndex === null || selectedPoolIndex === null">
                            X√°c nh·∫≠n ƒê·ªïi (Swap)
                        </button>
                    </div>
                    <div v-else>
                        <p>ƒêang ƒë·ª£i l∆∞·ª£t c·ªßa: <strong>{{ currentTurnName }}</strong></p>
                    </div>
                </div>
            </div>

            <div v-if="isHost && gamePhase === 'offering'" style="margin-top: 20px; border-top: 1px dashed white; padding-top:10px;">
                <h4>Quy·ªÅn Ch·ªß Ph√≤ng</h4>
                <p>ƒê√£ G√≥p: {{ offeredCount }} / {{ players.length }}</p>
                <button @click="hostLockOffers" :disabled="offeredCount < players.length">Kh√≥a G√≥p & B·∫Øt ƒë·∫ßu ƒê·ªïi</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove, onDisconnect } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // C·∫§U H√åNH T·ª™ ·∫¢NH C·ª¶A B·∫†N
        const firebaseConfig = {
            apiKey: "AIzaSyAfYIW3kg5BZxS9pbXny5JsQGv70VK0DiQ",
            authDomain: "caonem-5c040.firebaseapp.com",
            databaseURL: "https://caonem-5c040-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "caonem-5c040",
            storageBucket: "caonem-5c040.firebasestorage.app",
            messagingSenderId: "1097973722396",
            appId: "1:1097973722396:web:bb0b017146a7d974e31ed9",
            measurementId: "G-EQTSX790Z2"
        };

        // Kh·ªüi t·∫°o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    step: 'login', // login, lobby, game
                    loading: false,
                    myName: '',
                    myId: '',
                    roomId: '',
                    joinId: '',
                    
                    // D·ªØ li·ªáu ƒë·ªìng b·ªô t·ª´ Firebase
                    players: [], // [{id, name, hand:[], tempOffer: null, hasOffered: false}]
                    gameState: {
                        hostId: '',
                        phase: 'lobby', // lobby, offering, picking
                        pool: [],
                        turnIndex: 0,
                        msg: ''
                    },

                    // Local UI State
                    selectedHandIndex: null,
                    selectedPoolIndex: null,
                }
            },
            computed: {
                isHost() { return this.gameState.hostId === this.myId; },
                hostName() {
                    const h = this.players.find(p => p.id === this.gameState.hostId);
                    return h ? h.name : 'Unknown';
                },
                me() { return this.players.find(p => p.id === this.myId) || {}; },
                myHand() { return this.me.hand || []; },
                hasOffered() { return this.me.hasOffered || false; },
                pool() { return this.gameState.pool || []; },
                gamePhase() { return this.gameState.phase; },
                statusMessage() { return this.gameState.msg; },
                currentTurnName() {
                    if (!this.players.length) return '';
                    return this.players[this.gameState.turnIndex].name;
                },
                isMyTurn() {
                    if (this.gamePhase !== 'picking') return false;
                    return this.players[this.gameState.turnIndex].id === this.myId;
                },
                offeredCount() {
                    return this.players.filter(p => p.hasOffered).length;
                }
